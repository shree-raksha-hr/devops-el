<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue-Green Demo Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; background: #f4f4f4; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .healthy { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #version, #health, #api-status { font-weight: bold; }
        button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .spinner { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>ðŸš€ Blue-Green Deployment Demo</h1>
    <p>Live Backend: <span id="version">Loading...</span></p>
    <div id="health" class="status info">Health Check: Loading...</div>
    <div id="api-status" class="status info">API Query (/api/status): Loading... (Simulates frontend request)</div>
    <p id="log" style="font-size: 12px; color: #666;">Last update: Never</p>

    <script>
        const BACKEND_URL = 'http://192.168.49.2:31351';  // e.g., http://192.168.49.2:3xxxx (from minikube service myapp-lb --url)

        async function fetchStatus() {
            try {
                const versionRes = await fetch(`${BACKEND_URL}/`);
                const versionText = await versionRes.text();
                document.getElementById('version').textContent = versionText.includes('v1') ? 'Blue Version' : 'Green Version';

                const healthRes = await fetch(`${BACKEND_URL}/health`);
                const healthText = await healthRes.text();
                const healthEl = document.getElementById('health');
                healthEl.textContent = `Health: ${healthText}`;
                healthEl.className = 'status ' + (healthRes.status === 200 ? 'healthy' : 'error');

                const apiRes = await fetch(`${BACKEND_URL}/api/status`);
                const apiText = await apiRes.text();
                const apiEl = document.getElementById('api-status');
                if (apiRes.status === 200) {
                    apiEl.textContent = `API: ${apiText} âœ“`;
                    apiEl.className = 'status healthy';
                } else {
                    apiEl.textContent = `API Error: ${apiRes.status} - ${apiText} âœ—`;
                    apiEl.className = 'status error';
                }

                document.getElementById('log').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                document.getElementById('api-status').textContent = `Network Error: ${err.message}`;
                document.getElementById('api-status').className = 'status error';
            }
        }

        function manualTrigger() {
            document.getElementById('spinner').style.display = 'block';
            setTimeout(() => {
                document.getElementById('spinner').style.display = 'none';
                alert('Pipeline triggered! Watch the switch & rollback in logs. (Manually start in Jenkins for demo)');
            }, 2000);
        }

        fetchStatus();
        setInterval(fetchStatus, 5000);
    </script>
</body>
</html>